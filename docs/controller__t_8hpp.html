<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>eRumby-Firmware: controller_t.hpp File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="header.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">eRumby-Firmware
   &#160;<span id="projectnumber">1.0.0-beta</span>
   </div>
   <div id="projectbrief">Firmware for the eRumby low level microcontroller</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#typedef-members">Typedefs</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">controller_t.hpp File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;Arduino.h&gt;</code><br />
<code>#include &quot;configurations.hpp&quot;</code><br />
<code>#include &quot;<a class="el" href="cyclic__array__t_8hpp_source.html">cyclic_array_t.hpp</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="types_8hpp_source.html">types.hpp</a>&quot;</code><br />
</div>
<p><a href="controller__t_8hpp_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classcontroller__t.html">controller_t</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">The actual ESC controller.  <a href="classcontroller__t.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classcontroller__t_1_1esc__sp__t.html">controller_t::esc_sp_t</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">A specific Smith predictor with the ESC non linearity.  <a href="classcontroller__t_1_1esc__sp__t.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr class="memitem:a68fa5fb51e0e0b733978cd8d35f60ee0"><td class="memTemplParams" colspan="2">template&lt;timing_t MILLIS, timing_t DELAY&gt; </td></tr>
<tr class="memitem:a68fa5fb51e0e0b733978cd8d35f60ee0"><td class="memTemplItemLeft" align="right" valign="top">using&#160;</td><td class="memTemplItemRight" valign="bottom"><a class="el" href="controller__t_8hpp.html#a68fa5fb51e0e0b733978cd8d35f60ee0">time_delay_t</a> = <a class="el" href="classcyclic__array__t.html">cyclic_array_t</a>&lt; float, DELAY/MILLIS &gt;</td></tr>
<tr class="memdesc:a68fa5fb51e0e0b733978cd8d35f60ee0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Class wich implements a PI controller.  <a href="#a68fa5fb51e0e0b733978cd8d35f60ee0">More...</a><br /></td></tr>
<tr class="separator:a68fa5fb51e0e0b733978cd8d35f60ee0"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a1a6cfa6d2b2f166cc7d6101debcc62dd"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="controller__t_8hpp.html#a1a6cfa6d2b2f166cc7d6101debcc62dd">smith_predictor_t</a> (float a)</td></tr>
<tr class="memdesc:a1a6cfa6d2b2f166cc7d6101debcc62dd"><td class="mdescLeft">&#160;</td><td class="mdescRight">Smith predictor.  <a href="#a1a6cfa6d2b2f166cc7d6101debcc62dd">More...</a><br /></td></tr>
<tr class="separator:a1a6cfa6d2b2f166cc7d6101debcc62dd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae17066c4beaa0c5e686382775a4ad6b9"><td class="memItemLeft" align="right" valign="top">const void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="controller__t_8hpp.html#ae17066c4beaa0c5e686382775a4ad6b9">operator()</a> (const float u)</td></tr>
<tr class="memdesc:ae17066c4beaa0c5e686382775a4ad6b9"><td class="mdescLeft">&#160;</td><td class="mdescRight">Main loop for the Smith predictor.  <a href="#ae17066c4beaa0c5e686382775a4ad6b9">More...</a><br /></td></tr>
<tr class="separator:ae17066c4beaa0c5e686382775a4ad6b9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8d6b0e04649210dee0e1cf75b9788b2f"><td class="memItemLeft" align="right" valign="top">virtual const float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="controller__t_8hpp.html#a8d6b0e04649210dee0e1cf75b9788b2f">phi</a> (const float u) const</td></tr>
<tr class="memdesc:a8d6b0e04649210dee0e1cf75b9788b2f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Output non linearity.  <a href="#a8d6b0e04649210dee0e1cf75b9788b2f">More...</a><br /></td></tr>
<tr class="separator:a8d6b0e04649210dee0e1cf75b9788b2f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a62d327383dd7da6b72813a42096fb929"><td class="memItemLeft" align="right" valign="top">const float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="controller__t_8hpp.html#a62d327383dd7da6b72813a42096fb929">state</a> () const</td></tr>
<tr class="memdesc:a62d327383dd7da6b72813a42096fb929"><td class="mdescLeft">&#160;</td><td class="mdescRight">The value of the output in the internal model (with delay)  <a href="#a62d327383dd7da6b72813a42096fb929">More...</a><br /></td></tr>
<tr class="separator:a62d327383dd7da6b72813a42096fb929"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac87719344d07f205f6cd25778e60b598"><td class="memItemLeft" align="right" valign="top">const float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="controller__t_8hpp.html#ac87719344d07f205f6cd25778e60b598">state_predict</a> () const</td></tr>
<tr class="memdesc:ac87719344d07f205f6cd25778e60b598"><td class="mdescLeft">&#160;</td><td class="mdescRight">The value of the output prediction in the internal model (without delay)  <a href="#ac87719344d07f205f6cd25778e60b598">More...</a><br /></td></tr>
<tr class="separator:ac87719344d07f205f6cd25778e60b598"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac288f079bbaad86c1da3370085f46451"><td class="memItemLeft" align="right" valign="top"><a id="ac288f079bbaad86c1da3370085f46451"></a>
const void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="controller__t_8hpp.html#ac288f079bbaad86c1da3370085f46451">reset</a> ()</td></tr>
<tr class="memdesc:ac288f079bbaad86c1da3370085f46451"><td class="mdescLeft">&#160;</td><td class="mdescRight">resets the internal model delay and dynamical system to 0 <br /></td></tr>
<tr class="separator:ac288f079bbaad86c1da3370085f46451"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a55de7e7f3dc8c8ba62167de65dfeb000"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="controller__t_8hpp.html#a55de7e7f3dc8c8ba62167de65dfeb000">gain</a> (const float a)</td></tr>
<tr class="memdesc:a55de7e7f3dc8c8ba62167de65dfeb000"><td class="mdescLeft">&#160;</td><td class="mdescRight">Sets the constants for the dynamical system.  <a href="#a55de7e7f3dc8c8ba62167de65dfeb000">More...</a><br /></td></tr>
<tr class="separator:a55de7e7f3dc8c8ba62167de65dfeb000"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><dl class="section author"><dt>Author</dt><dd>Matteo Ragni, Davide Piscini, Matteo Cocetti</dd></dl>
<p>The file contains the code employed in the ESC control. The ESC control receives a <code>float</code> with the reference for the wheel speed and try to set the PWM pulse witdh in order to obtain such value.</p>
<p>The scheme of the controller follows: </p><div class="fragment"><div class="line">                                                         +------------+</div><div class="line">                                            u in (0,1)   |            |       Output to ESC PWM pin</div><div class="line">                                          +-------------&gt;+ PWM_map(u) +------------------------------&gt;</div><div class="line">                +--------------+          |              |            |</div><div class="line">                |              | u_ff     |              +------------+</div><div class="line">       +-------&gt;+ PHI_INV(w_r) +------+   |</div><div class="line">       |        |              |      |   |</div><div class="line">       |        +--------------+      |   |                  Smith Predictor with a copy of the plant</div><div class="line">       |                              |   |</div><div class="line">       |        +--------------+      |   |   +--------+     +------------------+     +----------+</div><div class="line">       | +   e  |              | u_fb V+  |   |        |  q  |                  |  x  |          |</div><div class="line"> w_r --+-&gt;O-----+ PI Ctrl      +-----&gt;O---+--&gt;+ SAT(u) +----&gt;+ dx = -a x + a q  +--+-&gt;+ exp(-ds) +----+</div><div class="line">          ^-    |              |     +        |        |     |                  |  |  |          |    |</div><div class="line">          |     +--------------+              +--------+     +------------------+  |  +----------+    |</div><div class="line">          |                                                                        |                  |</div><div class="line">          |                                                           +--------+   |   Delay          |</div><div class="line">          |+                                                          |        |   |                  |</div><div class="line">          O&lt;----------------------------------------------------------+ PHI(w) +&lt;--+ x                |</div><div class="line">         +^                             w_sp                          |        |                      |</div><div class="line">          |                                                           +--------+                      |</div><div class="line">          |                                                                                           |</div><div class="line">          |                                                           +--------+                      |</div><div class="line">          |                                                           |        |                      |</div><div class="line">w_hg ----&gt;O&lt;----------------------------------------------------------+ PHI(w) +&lt;---------------------+</div><div class="line">         + -                            w_sp (delayed)                |        |     x (delayed)</div><div class="line">                                                                      +--------+</div></div><!-- fragment --><p>The controller is composed by several parts, and in particular we have as input to the scheme:</p><ul>
<li><code>w_r</code> that is the reference set point</li>
<li><code>w_hg</code> that is the estimation coming from the high gain observers in the <code><a class="el" href="classencoder__t.html">encoder_t</a></code>. To be precise \( \omega_{hg} = \frac{1}{2} ( \omega_{hg,left} + \omega_{hg,right} )\)</li>
<li><code>w_sp</code> is the prediction of the speed of the wheel for the system without delay predicted by the Smith predictor. The plant is modeled as a 1 state wiener model: <p class="formulaDsp">
\[ \dot{x} = - a x + a \mathrm{sat}(u) \]
</p>
 with the nonlinear output: <p class="formulaDsp">
\[ \omega_{sp} = \phi(u) = \frac{\sqrt{c_1^2 + 4 c_2 u}}{2 c_2} \]
</p>
 the parameters \( a, c_1, c_2 \) should be identified and inserted in the <code>configure.hpp</code> file.</li>
<li><code>u</code> is the output to be sent to the esc as a PWM.</li>
</ul>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Param  </th><th class="markdownTableHeadNone">Define  </th><th class="markdownTableHeadNone">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">\( a \)  </td><td class="markdownTableBodyNone"><code>CTRL_MODEL_A</code>  </td><td class="markdownTableBodyNone">Dynamical system pole   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">\( c_1 \)  </td><td class="markdownTableBodyNone"><code>CTRL_NONLIN_A</code>  </td><td class="markdownTableBodyNone">Non linearity first coefficient   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">\( c_2 \)  </td><td class="markdownTableBodyNone"><code>CTRL_NONLIN_B</code>  </td><td class="markdownTableBodyNone">Non linearity second coefficient   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">\( d \)  </td><td class="markdownTableBodyNone"><code>CTRL_SYSTEM_DELAY</code>  </td><td class="markdownTableBodyNone">Delay: ( \(mod(d,t_s) = 0\)! (in ms)   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">\( t_s \)  </td><td class="markdownTableBodyNone"><code>LOOP_TIMING</code>  </td><td class="markdownTableBodyNone">Time step for integration (in ms)   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">\( k_p \)  </td><td class="markdownTableBodyNone"><code>CTRL_KP</code>  </td><td class="markdownTableBodyNone">PI controller proportional gain   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">\( k_i \)  </td><td class="markdownTableBodyNone"><code>CTRL_KI</code>  </td><td class="markdownTableBodyNone">PI controller integrative gain   </td></tr>
</table>
<p><b>DELAY and LOOP_TIMING</b>: the controller has been built with the idea of running in the real time loop, which runs approximatively a 250Hz (4 ms). The Delay identified for the system is nominally 80 ms. Please notice that the integer division between delay and loop timing must have no residuals (<code>CTRL_SYSTEM_DELAY % LOOP_TIMING == 0</code>), in order to discretize correctly the delay.</p>
<dl class="section warning"><dt>Warning</dt><dd>The delay is a characteristic of this particular system. It is not possible to eliminate it via software.</dd>
<dd>
All the hardcoded constants are concentrated in the class <code>controller_t!</code> </dd></dl>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="classcontroller__t.html" title="The actual ESC controller. ">controller_t</a> </dd></dl>

<p class="definition">Definition in file <a class="el" href="controller__t_8hpp_source.html">controller_t.hpp</a>.</p>
</div><h2 class="groupheader">Typedef Documentation</h2>
<a id="a68fa5fb51e0e0b733978cd8d35f60ee0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a68fa5fb51e0e0b733978cd8d35f60ee0">&#9670;&nbsp;</a></span>time_delay_t</h2>

<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;timing_t MILLIS, timing_t DELAY&gt; </div>
      <table class="memname">
        <tr>
          <td class="memname">using <a class="el" href="controller__t_8hpp.html#a68fa5fb51e0e0b733978cd8d35f60ee0">time_delay_t</a> =  <a class="el" href="classcyclic__array__t.html">cyclic_array_t</a>&lt; float, DELAY / MILLIS &gt;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Class wich implements a PI controller. </p>
<p>The class implements a PI controller with an Backward Euler discretization: </p><p class="formulaDsp">
\[ s = \frac{z - 1}{t_s z} \]
</p>
<p> The constructor takes as arguments the proportional and integrative gains and evaluates internally the discretization. Do not discretize the gains manually.</p>
<p>The internal recursion will be: </p><p class="formulaDsp">
\begin{align} x_{k} &amp; = x_{k - 1} + t_s e{k} \\ u_{k} &amp; = k_i x_{k - 1} + (k_p + t_s k_i) e_{k} \f{align} Usage example: @code static const timing_t ts = 4; // ms pi_ctrl_t&lt;ts&gt; ctrl(1.0, 0.0); // Proportional only controller with kp = 1 // and sample time 4ms void real_time_loop() { float reference = get_reference(); // get the reference float measure = get_measure(); // output of the system float u = ctrl(reference - measure); // evaluate your new control set_control(u); // Set your control } @endcode \tparam MILLIS the discretization time in ms. Should be equal to the real time loop timing */ template &lt; timing_t MILLIS &gt; class pi_ctrl_t { const static float ts = float(MILLIS) / 1000.0; /**&lt; Time step in seconds */ float ei; /**&lt; Integral of the error */ float kp; /**&lt; \f$k_p = k_{p,in} + t_s k_{i,in} \f$: discretized proportional gain */ float ki; /**&lt; \f$k_i = k{i,in}\f$: discretized integrative gain */ public: /** \brief Empty constructor, sets the gains to zero */ pi_ctrl_t() : ei(0) { gain(0, 0); } /** \brief Normal constructor, evaluates the gain and discretize This constructor takes the gains as input and evaluates the gains for the discretized version of the controller. \param kp_ \f$ k_{p,in} \f$: proportional gain of the controller \param ki_ \f$ k_{i,in} \f$: integrative gain of the controller */ pi_ctrl_t(const float kp_, const float ki_) : ei(0) { gain(kp_, ki_); } /** \brief Updates the gain of the controller Changes the gain of the controller evaluating the following discretized gain: \f{align} k_p &amp; = k_{p,in} + t_s k_{i,in} \\ k_i &amp; = k_{i,in} \f{align} \param kp_ \f$ k_{p,in} \f$: proportional gain of the controller \param ki_ \f$ k_{i,in} \f$: integrative gain of the controller */ void gain(const float kp_, const float ki_) { ki = ki_; kp = kp_ + ts * ki_; } /** \brief Evaluate control using error Evaluates the next control action using the current error. The error is the difference between setpoint (\f$ r \f$) and current reading (\f$ y \f$). \param e current error (\f$r - y\f$) \return the control action */ const float operator()(const float e) { float u = ki * ei + kp * e; ei += ts * e; return u; } /** \brief reset the internal state of the controller */ void reset() { ei = 0; } /** \brief reset the internal state of the controller \param ei_ new value of the state */ void reset(const float ei_) { ei = ei_; } }; /** \brief Dicretization of the time delay The time delay is a \p cyclic_array_t that has a memory size which is \f$ n = \mathrm{floor}(d / t_s) \f$. The discretized system is: \f{align} x_{1}^{k+1} &amp;= x_2^{k} \\ x_{2}^{k+1} &amp;= x_3^{k} \\ &amp; \vdots x_{n-1}^{k+1} &amp;= x_n^{k} \\ x_n^{k+1} &amp;= u \f{align} Using templates for the creation of this kind of delay has an advantage in terms of code efficiency, but as drawback the delay is fixed at compile time. This also implies that the following should be respected. \f[ \mathrm{mod}(d^{(ms)}, t_s^{(ms)}) = 0 \]
</p>
<dl class="tparams"><dt>Template Parameters</dt><dd>
  <table class="tparams">
    <tr><td class="paramname">MILLIS</td><td>discretization time in millisecond </td></tr>
    <tr><td class="paramname">DELAY</td><td>delay in milliseconds </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="controller__t_8hpp_source.html#l00208">208</a> of file <a class="el" href="controller__t_8hpp_source.html">controller_t.hpp</a>.</p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="a1a6cfa6d2b2f166cc7d6101debcc62dd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1a6cfa6d2b2f166cc7d6101debcc62dd">&#9670;&nbsp;</a></span>smith_predictor_t()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">smith_predictor_t </td>
          <td>(</td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>a</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Smith predictor. </p>
<p>An implementation of a smith predictor for the following linear plant: </p><p class="formulaDsp">
\begin{align} \dot{x}(t) &amp; = - a x(t) + a \mathrm{sat}(u(t - d)) \\ y(t) &amp; = \phi(x(t)) \f{align} This class is taylored made for our ESC system. The integration of this system is performed with a Backward Euler \f$ s = \frac{z-1}{t_s z} \f$ and the recursion follows: \f{align} q_{k} &amp; = \mathrm{sat}_{[0,1]}(t_{k}) \\ x_{k} &amp; = a_{sp} x_{k-1} + b_{sp} q_{k} \\ y_{k} &amp; = \phi(x_{k}) = \frac{\sqrt{c_1^2 + 4 c_2 x_{k}} - c_1}{2 c_2} \f{align} where: \f{align} a_{sp} = (1 + a t_s)^{-1} b_{sp} = a_{sp} a t_s \f{align} The actual output in the control loop, for a discretization of the delay in a cyclic array with size \f$ n = \mathrm{floor}(d / t_s) \f$, follows: \f{align} \omega &amp;= y_{k - n} \\ \omega_{predict} &amp;= y{k} \f{align} \warning The non linearity is a **virtual** method. Thus it should be redefined in the controller. \tparam MILLIS discretization time in millisecond \tparam DELAY delay in milliseconds */ template &lt; timing_t MILLIS, timing_t DELAY &gt; class smith_predictor_t { const static float ts = float(MILLIS) / 1000.0; /**&lt; Time step in seconds */ const static float d = float(DELAY) / 1000.0; /**&lt; Delay in seconds */ float a_sp; /**&lt; state gain for discretization */ float b_sp; /**&lt; input gain for discretization */ time_delay_t&lt; MILLIS, DELAY &gt; delay; /**&lt; Delay system */ public: /** \brief Empty constructor, gain to zero */ smith_predictor_t() : a_sp(0), b_sp(0), delay(0){}; /** \brief Constructor, which sets the constants for the dynamical system. The constructor evaluates: \f{align} a_{sp} = (1 + a t_s)^{-1} b_{sp} = a_{sp} a t_s \f{align} which are the discretized (with Backward Euler) counterpart for the linear plant: \f[ \dot{x} = -a x + a u \]
</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">a</td><td>the \( a \) of the dynamical system </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="controller__t_8hpp_source.html#l00273">273</a> of file <a class="el" href="controller__t_8hpp_source.html">controller_t.hpp</a>.</p>

</div>
</div>
<a id="ae17066c4beaa0c5e686382775a4ad6b9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae17066c4beaa0c5e686382775a4ad6b9">&#9670;&nbsp;</a></span>operator()()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const void operator() </td>
          <td>(</td>
          <td class="paramtype">const float&#160;</td>
          <td class="paramname"><em>u</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Main loop for the Smith predictor. </p>
<p>The main loop of the Smith predictor executes the following recursion: </p><p class="formulaDsp">
\[ x_{k} = a_{sp} x_{k-1} + b_{sp} \mathrm{sat}_{[0,1]}(u) \]
</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">u</td><td>the last input to the dynamical system </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="controller__t_8hpp_source.html#l00284">284</a> of file <a class="el" href="controller__t_8hpp_source.html">controller_t.hpp</a>.</p>

</div>
</div>
<a id="a8d6b0e04649210dee0e1cf75b9788b2f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8d6b0e04649210dee0e1cf75b9788b2f">&#9670;&nbsp;</a></span>phi()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">virtual const float phi </td>
          <td>(</td>
          <td class="paramtype">const float&#160;</td>
          <td class="paramname"><em>u</em></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">virtual</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Output non linearity. </p>
<p>The output of the smith predictor is subject to a non-linearity</p>
<dl class="section warning"><dt>Warning</dt><dd>In order to have a better generalization of the smith predictor the non linearity is a virtual function, with a trivial implementation (identity). The user should write her/his own implementation in the actual controller class, where the non linearity will be specific for the application.</dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">u</td><td>input of the non linearity </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the output of the non linearity \( \phi(u) \) </dd></dl>

<p class="definition">Definition at line <a class="el" href="controller__t_8hpp_source.html#l00305">305</a> of file <a class="el" href="controller__t_8hpp_source.html">controller_t.hpp</a>.</p>

</div>
</div>
<a id="a62d327383dd7da6b72813a42096fb929"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a62d327383dd7da6b72813a42096fb929">&#9670;&nbsp;</a></span>state()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const float state </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>The value of the output in the internal model (with delay) </p>
<dl class="section return"><dt>Returns</dt><dd>the value of the output in the internal model </dd></dl>

<p class="definition">Definition at line <a class="el" href="controller__t_8hpp_source.html#l00311">311</a> of file <a class="el" href="controller__t_8hpp_source.html">controller_t.hpp</a>.</p>

</div>
</div>
<a id="ac87719344d07f205f6cd25778e60b598"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac87719344d07f205f6cd25778e60b598">&#9670;&nbsp;</a></span>state_predict()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const float state_predict </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>The value of the output prediction in the internal model (without delay) </p>
<dl class="section return"><dt>Returns</dt><dd>the value of the output prediction in the internal model </dd></dl>

<p class="definition">Definition at line <a class="el" href="controller__t_8hpp_source.html#l00316">316</a> of file <a class="el" href="controller__t_8hpp_source.html">controller_t.hpp</a>.</p>

</div>
</div>
<a id="a55de7e7f3dc8c8ba62167de65dfeb000"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a55de7e7f3dc8c8ba62167de65dfeb000">&#9670;&nbsp;</a></span>gain()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void gain </td>
          <td>(</td>
          <td class="paramtype">const float&#160;</td>
          <td class="paramname"><em>a</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Sets the constants for the dynamical system. </p>
<p>The function sets: </p><p class="formulaDsp">
\begin{align} a_{sp} = (1 + a t_s)^{-1} b_{sp} = a_{sp} a t_s \f{align} which are the discretized (with Backward Euler) counterpart for the linear plant: \f[ \dot{x} = -a x + a u \]
</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">a</td><td>the \( a \) of the dynamical system </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="controller__t_8hpp_source.html#l00336">336</a> of file <a class="el" href="controller__t_8hpp_source.html">controller_t.hpp</a>.</p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Nov 14 2018 11:52:43 for eRumby-Firmware by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.14
</small></address>
</body>
</html>
